name: Deploy Backend to Cloud Run

on:
  push:
    branches:
      - main

env:
  PROJECT_ID: entregas-476319
  REGION: southamerica-east1
  REPO: entregas-repo
  SERVICE: bot-entregas
  IMAGE: "southamerica-east1-docker.pkg.dev/entregas-476319/entregas-repo/backend-v1"

jobs:
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest

    steps:
    # -------------------------------------------------------------
    # 1) Checkout del código
    # -------------------------------------------------------------
    - name: Checkout
      uses: actions/checkout@v3

    # -------------------------------------------------------------
    # 2) Autenticación con Google Cloud
    # -------------------------------------------------------------
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    # -------------------------------------------------------------
    # 3) Instalar gcloud
    # -------------------------------------------------------------
    - name: Setup gcloud
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ env.PROJECT_ID }}
        install_components: "beta"

    # -------------------------------------------------------------
    # 4) Build con Cloud Build (sin streaming)
    # -------------------------------------------------------------
    - name: Build with Cloud Build
      uses: google-github-actions/cloud-build@v0
      with:
        project_id: ${{ env.PROJECT_ID }}
        config: cloudbuild.yaml

    # -------------------------------------------------------------
    # 5) Deploy a Cloud Run
    # -------------------------------------------------------------
    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy $SERVICE \
          --image "$IMAGE" \
          --region "$REGION" \
          --platform managed \
          --port 8080 \
          --allow-unauthenticated
